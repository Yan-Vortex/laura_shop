<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Laura Shop — Catalogue</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --accent:#8e44ad; --muted:#666;
  --radius:12px; --shadow:0 4px 15px rgba(0,0,0,0.08);
}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);}
header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:var(--accent);color:#fff;}
header .brand{font-weight:bold;font-size:20px;}
nav button{margin-left:8px;padding:6px 10px;border:none;border-radius:8px;cursor:pointer;background:#fff;color:var(--accent);}
.container{max-width:1100px;margin:20px auto;padding:0 15px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;}
.card img{width:100%;height:160px;object-fit:cover;}
.card-body{padding:10px;flex:1;display:flex;flex-direction:column;}
.card-body .name{font-weight:700;margin-bottom:4px;}
.card-body .desc{color:var(--muted);font-size:13px;margin-bottom:6px;}
.card-body .price{font-weight:700;margin-bottom:6px;}
.card-actions{display:flex;gap:6px;align-items:center;margin-top:auto;}
.card-actions .btn{flex:1;text-align:center;text-decoration:none;color:#fff;padding:6px 0;border-radius:8px;background:var(--accent);}
#admin-panel{position:fixed;bottom:18px;right:18px;width:320px;background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow);display:none;z-index:100;}
#admin-panel.show{display:block;}
#admin-panel input, #admin-panel textarea, #admin-panel select{width:100%;margin-bottom:8px;padding:8px;border-radius:8px;border:1px solid #ccc;}
#preview img{max-width:100%;border-radius:8px;}
#img-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:200;}
#img-modal img{max-width:90%;max-height:90%;border-radius:12px;}
#img-modal span{position:absolute;top:20px;right:30px;font-size:32px;color:#fff;cursor:pointer;font-weight:bold;}
#section-nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:15px;}
#section-nav button{padding:6px 12px;border-radius:999px;border:1px solid rgba(142,68,173,0.2);background:transparent;color:var(--accent);cursor:pointer;}
#section-nav button.active{background:var(--accent);color:#fff;border-color:var(--accent);}
</style>
</head>
<body>

<header>
  <div class="brand">Laura Shop</div>
  <nav>
    <button id="admin-btn">Admin</button>
  </nav>
</header>

<main class="container">
  <div id="section-nav"></div>
  <div class="grid" id="products-grid">Chargement…</div>
</main>

<div id="img-modal">
  <span id="close-modal">&times;</span>
  <img src="" alt="Produit">
</div>

<div id="admin-panel">
  <h3>Admin <button id="admin-toggle">–</button></h3>
  <div id="admin-content">
    <input id="name-input" placeholder="Nom du produit">
    <input id="price-input" placeholder="Prix">
    <textarea id="desc-input" placeholder="Description"></textarea>
    <select id="section-select"></select>
    <input type="file" id="file">
    <div id="preview"></div>
    <button id="add-btn">Ajouter / Modifier</button>
    <button id="logout">Se déconnecter</button>

    <h4>Sections</h4>
    <input id="section-input" placeholder="Nom de la section">
    <button id="add-section-btn">Ajouter / Modifier</button>
    <ul id="sections-list"></ul>
  </div>
</div>

<script>
const API = "https://api-fugh.onrender.com";
let editingId=null, editingSectionId=null;

// ----------------------
// ADMIN STATE
// ----------------------
function isAdmin(){ return sessionStorage.getItem('admin')==='1'; }
function setAdmin(v){ sessionStorage.setItem('admin',v?'1':'0'); updateAdminUI(); }

// ----------------------
// FETCH
// ----------------------
async function apiGet(url){ const r=await fetch(url); return r.ok?await r.json():[]; }
async function apiPost(url,body){ const r=await fetch(url,{method:'POST',body:body instanceof FormData?body:JSON.stringify(body), headers:body instanceof FormData?{}:{'Content-Type':'application/json'}}); return r.ok?await r.json():null; }
async function apiPut(url,body){ const r=await fetch(url,{method:'PUT',body:body instanceof FormData?body:JSON.stringify(body), headers:body instanceof FormData?{}:{'Content-Type':'application/json'}}); return r.ok?await r.json():null; }
async function apiDelete(url){ const r=await fetch(url,{method:'DELETE'}); return r.ok; }

// ----------------------
// RENDER SECTIONS
// ----------------------
async function loadSections(){ return await apiGet(API+"/sections"); }
async function renderSections(){
  const sections = await loadSections();
  const sel = document.getElementById("section-select");
  sel.innerHTML='<option value="">-- Choisir section --</option>';
  sections.forEach(s=>{ const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; sel.appendChild(o); });

  const list = document.getElementById("sections-list");
  list.innerHTML='';
  sections.forEach(s=>{
    const li=document.createElement("li");
    li.innerHTML=`${s.name} <button onclick="startEditSection(${s.id},'${s.name}')">Edit</button> <button onclick="deleteSection(${s.id})">Suppr</button>`;
    list.appendChild(li);
  });

  buildSectionNav(sections);
}

// ----------------------
// RENDER PRODUCTS
// ----------------------
async function loadProducts(){ return await apiGet(API+"/products"); }
async function renderProducts(){
  const grid = document.getElementById("products-grid");
  grid.innerHTML='';
  const products = await loadProducts();
  const sections = await loadSections();
  products.forEach(p=>{
    const card = document.createElement("div");
    card.className='card';
    card.innerHTML=`
      <img src="${p.image}" onclick="showImg('${p.image}')">
      <div class="card-body">
        <div class="name">${p.name}</div>
        <div class="desc">${p.description}</div>
        <div class="price">${p.price} Fcfa</div>
        ${isAdmin()?`<div class="card-actions">
          <button onclick="startEdit(${p.id})">Edit</button>
          <button onclick="deleteProduct(${p.id})">Suppr</button>
        </div>`:''}
      </div>`;
    grid.appendChild(card);
  });
}

// ----------------------
// ADMIN ACTIONS
// ----------------------
async function addOrUpdate(){
  const name=document.getElementById("name-input").value.trim();
  const price=document.getElementById("price-input").value.trim();
  const desc=document.getElementById("desc-input").value.trim();
  const sectionId=document.getElementById("section-select").value;
  const file=document.getElementById("file").files[0];

  if(!name || !price || !sectionId){ alert("Nom, prix et section requis"); return; }

  const form=new FormData();
  form.append("name",name);
  form.append("price",price);
  form.append("description",desc);
  form.append("sectionId",sectionId);
  if(file) form.append("image",file);

  if(editingId) await apiPut(API+"/products/"+editingId,form);
  else await apiPost(API+"/products",form);

  editingId=null;
  document.getElementById("name-input").value='';
  document.getElementById("price-input").value='';
  document.getElementById("desc-input").value='';
  document.getElementById("section-select").value='';
  document.getElementById("file").value='';
  document.getElementById("preview").innerHTML='';

  renderProducts();
}

// ----------------------
// EDIT / DELETE
// ----------------------
function startEdit(id){
  editingId=id;
  loadProducts().then(products=>{
    const p=products.find(x=>x.id===id);
    if(!p) return;
    document.getElementById("name-input").value=p.name;
    document.getElementById("price-input").value=p.price;
    document.getElementById("desc-input").value=p.description;
    document.getElementById("section-select").value=p.sectionId;
    if(p.image) document.getElementById("preview").innerHTML=`<img src="${p.image}">`;
  });
}
async function deleteProduct(id){ if(confirm("Supprimer ?")){ await apiDelete(API+"/products/"+id); renderProducts(); } }

// ----------------------
// SECTIONS EDIT/DELETE
// ----------------------
function startEditSection(id,name){ editingSectionId=id; document.getElementById("section-input").value=name; }
async function deleteSection(id){ if(confirm("Supprimer section ?")){ await apiDelete(API+"/sections/"+id); renderSections(); renderProducts(); } }
async function addOrUpdateSection(){ const name=document.getElementById("section-input").value.trim(); if(!name)return; const body={name}; if(editingSectionId){ await apiPut(API+"/sections/"+editingSectionId,body); editingSectionId=null; } else { await apiPost(API+"/sections",body); } document.getElementById("section-input").value=''; renderSections(); }

// ----------------------
// IMAGE MODAL
// ----------------------
function showImg(src){ const modal=document.getElementById("img-modal"); modal.style.display='flex'; modal.querySelector('img').src=src; }
document.getElementById("close-modal").onclick=()=>{ document.getElementById("img-modal").style.display='none'; }

// ----------------------
// EVENTS
// ----------------------
document.getElementById("file").onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>document.getElementById("preview").innerHTML=`<img src="${r.result}">`;
  r.readAsDataURL(f);
};
document.getElementById("add-btn").onclick=addOrUpdate;
document.getElementById("add-section-btn").onclick=addOrUpdateSection;
document.getElementById("admin-btn").onclick=()=>{
  const pw=prompt("Mot de passe admin");
  if(pw==="Laure1975") setAdmin(true);
  else alert("Incorrect");
};
document.getElementById("logout").onclick=()=>setAdmin(false);
document.getElementById("admin-toggle").onclick=()=>{
  const c=document.getElementById("admin-content");
  if(c.style.display==='none'){ c.style.display='block'; } else { c.style.display='none'; }
};

// ----------------------
// INIT
// ---------------------=
renderSections();
renderProducts();
if(isAdmin()) updateAdminUI();

function updateAdminUI(){ document.getElementById("admin-panel").classList.toggle("show",isAdmin()); renderProducts(); renderSections(); }
</script>
</body>
</html>

