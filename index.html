<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
<title>Laura Shop's ‚Äî Catalogue</title>
<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --accent:#8e44ad;
  --muted:#666;
  --glass: rgba(255,255,255,0.6);
  --radius:12px;
  --shadow:0 6px 18px rgba(19,24,33,0.08);
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
body{margin:0;background:linear-gradient(180deg,#f7fbfb 0%,var(--bg) 100%);color:#111}
header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;background:transparent}
.brand{display:flex;gap:12px;align-items:center;position:relative}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#a569bd);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;cursor:pointer;position:relative}
#admin-btn{position:absolute;top:0;left:0;width:44px;height:44px;opacity:0;cursor:pointer;z-index:2}
.title{font-size:18px;font-weight:700}
nav{display:flex;gap:10px;align-items:center}
button, .btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid #e6e6e6}

.container{max-width:1100px;margin:26px auto;padding:0 18px}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:18px}
.search-container{flex:1;min-width:160px;position:relative}
.search{width:100%;padding:10px;border-radius:10px;border:1px solid #e7e7e7;padding-right:40px}
.clear-search{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);display:none}
input[type=text], input[type=search], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid #e7e7e7}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;position:relative}
.thumb{height:160px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;cursor:pointer}
.thumb img{max-width:100%;max-height:100%;object-fit:contain}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
.name{font-weight:700}
.desc{color:var(--muted);font-size:13px;min-height:36px}
.price{font-weight:800;font-size:16px}
.card-actions{display:flex;gap:8px;align-items:center}
.small{padding:8px 10px;border-radius:10px;font-size:13px}

.card-actions a {
  text-decoration: none;
}

footer{padding:20px;text-align:center;color:var(--muted);font-size:14px}

.admin-panel{position:fixed;right:18px;bottom:18px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);width:340px;max-width:calc(100% - 36px);display:none;z-index:60;transition:all 0.3s ease;overflow:hidden;}
.admin-panel.show{display:block}
.admin-panel h3{margin:0 0 8px 0;position:relative;padding-right:32px;}
.admin-panel h3 button{position:absolute;top:0;right:0;width:28px;height:28px;background:var(--accent);border:none;border-radius:50%;color:#fff;cursor:pointer;font-weight:bold;font-size:18px;display:flex;align-items:center;justify-content:center;}
.thumb-preview{width:84px;height:84px;border-radius:10px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:8px}

/* Animation de chargement pour images */
.thumb {
  background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* √âtat actif pour les boutons */
button:active, 
.btn:active {
  transform: scale(0.98);
  transition: transform 0.1s;
}

/* Scroll fluide */
html {
  scroll-behavior: smooth;
}

/* Emp√™cher le s√©lection de texte accidentel */
.card, button, .btn {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Am√©liorer la visibilit√© du focus */
button:focus-visible,
.btn:focus-visible,
input:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Styles pour appareils tactiles */
.touch-device .card {
  cursor: pointer;
}

.touch-device .card:active {
  background-color: rgba(142, 68, 173, 0.05);
}

/* Optimiser l'affichage du modal image */
#img-modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);align-items:center;justify-content:center}
#img-modal img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 0 20px #000}
#img-modal span{position:absolute;top:20px;right:30px;color:#fff;font-size:32px;cursor:pointer;font-weight:bold}

.admin-actions{display:flex;gap:6px;align-items:center}
.admin-actions .small{padding:6px 8px;border-radius:10px;font-size:13px}

@media (max-width:600px){
  .admin-actions .small{padding:10px 12px;font-size:15px;border-radius:12px}
  .card .admin-actions{position:absolute;right:10px;bottom:12px;flex-direction:row-reverse;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));padding:6px;border-radius:999px;box-shadow:var(--shadow)}
  .card .admin-actions .small{box-shadow:none}
  .card{padding-bottom:18px}
}

@media (min-width:601px){
  .card .admin-actions{position:static;padding:0;background:transparent}
}

#products-grid > div > h3{
  margin:16px 0 12px 0;
  font-size:20px;
  font-weight:700;
  color:var(--accent);
  text-transform: uppercase;
  border-bottom: 2px solid var(--accent);
  padding-bottom:6px;
  position:relative;
}
#products-grid > div > h3::after{
  content:'';
  position:absolute;
  left:0; bottom:-2px;
  width:50px;
  height:4px;
  background:var(--accent);
  border-radius:2px;
}

#products-grid > div{
  margin-bottom:28px;
  padding-bottom:12px;
  border-bottom:1px solid #eaeaea;
}

/* Styles pour la navigation compacte */
#section-nav-container {
  position: relative;
  margin: 12px 0 24px 0;
}

#section-nav {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  transition: all 0.3s ease;
}

#section-nav button {
  background: transparent;
  color: var(--accent);
  border: 1px solid rgba(142,68,173,0.15);
  padding: 8px 12px;
  border-radius: 999px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

#section-nav button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

#section-nav button:hover:not(.active) {
  background: rgba(142,68,173,0.1);
}

/* Bouton menu d√©roulant pour petits √©crans */
#section-nav-toggle {
  display: none;
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 16px;
  margin-bottom: 8px;
}

/* Menu lat√©ral pour les sections */
#section-nav-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 100;
}

#section-nav-sidebar {
  position: fixed;
  top: 0;
  left: -300px;
  width: 280px;
  height: 100%;
  background: white;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  z-index: 101;
  transition: left 0.3s ease;
  padding: 20px;
  overflow-y: auto;
}

#section-nav-sidebar.show {
  left: 0;
}

#section-nav-sidebar h3 {
  margin-top: 0;
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 10px;
}

#section-nav-sidebar-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 15px;
}

#section-nav-sidebar-buttons button {
  background: transparent;
  color: var(--accent);
  border: 1px solid rgba(142,68,173,0.15);
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s ease;
}

#section-nav-sidebar-buttons button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

#section-nav-sidebar-buttons button:hover:not(.active) {
  background: rgba(142,68,173,0.1);
}

#close-sidebar {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

/* Styles responsifs pour la navigation */
@media (max-width: 768px) {
  #section-nav {
    display: none;
  }
  
  #section-nav-toggle {
    display: inline-block;
  }
  
  #section-nav.show-on-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
}

@media (min-width: 769px) {
  #section-nav-overlay,
  #section-nav-sidebar {
    display: none !important;
  }
}

/* Styles pour les onglets admin */
.admin-tabs {
  display: flex;
  border-bottom: 1px solid #e7e7e7;
  margin-bottom: 12px;
}

.admin-tab {
  flex: 1;
  padding: 8px 12px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-size: 13px;
  color: var(--muted);
  transition: all 0.2s ease;
}

.admin-tab:hover {
  color: var(--accent);
}

.admin-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
  font-weight: 600;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Ajustements pour le contenu des onglets */
#products-tab input,
#products-tab textarea,
#products-tab select {
  margin-bottom: 8px;
  width: 100%;
}

#sections-tab input {
  margin-bottom: 8px;
  width: 100%;
}

#sections-list {
  max-height: 150px;
  overflow-y: auto;
  border: 1px solid #e7e7e7;
  border-radius: var(--radius);
  padding: 8px;
  margin-top: 8px;
  background: #f9f9f9;
}

#sections-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
  padding: 6px 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #f0f0f0;
  font-size: 13px;
}

#sections-list li:last-child {
  margin-bottom: 0;
}

/* ========== OPTIMISATIONS ANDROID ========== */

/* Optimisations sp√©cifiques Android */
@media (max-width: 480px) {
  .container {
    padding: 0 12px;
    margin: 16px auto;
  }
  
  /* MODIFICATION : 2 articles par ligne au lieu de 1 */
  .grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .card {
    border-radius: 10px;
  }
  
  .thumb {
    height: 140px; /* L√©g√®rement r√©duit pour 2 colonnes */
  }
  
  .card-body {
    padding: 10px;
  }
  
  .name {
    font-size: 14px; /* L√©g√®rement r√©duit pour 2 colonnes */
  }
  
  .desc {
    font-size: 12px; /* L√©g√®rement r√©duit pour 2 colonnes */
    min-height: 32px;
  }
  
  .price {
    font-size: 16px;
  }
  
  /* Agrandir les zones cliquables */
  .card-actions a, 
  .card-actions button {
    padding: 10px 12px;
    min-height: 40px;
    font-size: 12px;
  }
  
  /* Am√©liorer l'espacement des contr√¥les */
  .controls {
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .search, 
  #sort, 
  #section-filter {
    min-height: 44px;
    font-size: 16px;
  }
  
  /* Header plus compact */
  header {
    padding: 12px 15px;
  }
  
  .logo {
    width: 40px;
    height: 40px;
    font-size: 14px;
  }
  
  .title {
    font-size: 16px;
  }
  
  /* Optimiser l'affichage du modal image */
  #img-modal img {
    max-width: 95%;
    max-height: 80%;
  }
  
  #close-modal {
    top: 10px;
    right: 15px;
    font-size: 28px;
    padding: 8px;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Am√©liorer le panel admin sur mobile */
  .admin-panel {
    width: 90vw;
    right: 5vw;
    bottom: 10px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .admin-tabs {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
  }

  /* Afficher le bouton clear sur mobile */
  .clear-search {
    display: block;
  }
}

/* Am√©liorations pour les tr√®s petits √©crans */
@media (max-width: 360px) {
  .container {
    padding: 0 8px;
  }
  
  .grid {
    grid-template-columns: repeat(2, 1fr); /* Garder 2 colonnes m√™me sur tr√®s petits √©crans */
    gap: 8px;
  }
  
  .thumb {
    height: 120px; /* Encore plus r√©duit sur tr√®s petits √©crans */
  }
  
  .card-body {
    padding: 8px;
  }
  
  .name {
    font-size: 13px;
  }
  
  .desc {
    font-size: 11px;
    min-height: 28px;
  }
  
  .card-actions {
    flex-direction: column;
    gap: 6px;
  }
  
  .card-actions a,
  .card-actions .admin-actions {
    width: 100%;
    justify-content: center;
  }
}

/* Pr√©venir le zoom sur les inputs */
@media (max-width: 480px) {
  input[type="text"],
  input[type="search"],
  textarea,
  select {
    font-size: 16px;
  }
}

/* Am√©liorer le scroll sur Android */
.container {
  -webkit-overflow-scrolling: touch;
}

/* Pour les √©crans tr√®s petits */
@media (max-width: 400px) {
  .admin-panel {
    width: 320px;
    right: 10px;
    bottom: 10px;
  }
  
  #sections-list {
    max-height: 100px;
  }
}

/* Ajustements pour tablettes */
@media (min-width: 601px) and (max-width: 900px){
  .grid{grid-template-columns:repeat(3,1fr);}
}

@media (min-width: 901px){
  .grid{grid-template-columns:repeat(4,1fr);}
}

/* Afficher le bouton clear sur desktop aussi quand il y a du texte */
.search:not(:placeholder-shown) + .clear-search {
  display: block;
}

.lang-toggle{display:flex;gap:6px}
.chip{background:var(--glass);padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);cursor:pointer}

.notice{padding:10px;border-radius:10px;background:#fff;border:1px solid #eee;margin-bottom:12px}
.muted{color:var(--muted)}

/* Indicateur de chargement */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 40px;
  flex-direction: column;
  gap: 16px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-status {
  margin-top: 10px;
  font-size: 14px;
  color: var(--muted);
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">LS
      <button id="admin-btn" class="btn secondary"></button>
    </div>
    <div>
      <div class="title" id="shop-name">Laura Shop's</div>
      <div class="muted" id="shop-sub">Marketplace</div>
    </div>
  </div>
  <nav>
    <div class="lang-toggle">
      <div class="chip" id="lang-fr">FR</div>
      <div class="chip" id="lang-en">EN</div>
    </div>
  </nav>
</header>

<main class="container">
  <div id="section-nav-container">
    <button id="section-nav-toggle">...</button>
    <div id="section-nav"></div>
  </div>
  
  <!-- Menu lat√©ral pour mobile -->
  <div id="section-nav-overlay"></div>
  <div id="section-nav-sidebar">
    <button id="close-sidebar">&times;</button>
    <h3>Sections</h3>
    <div id="section-nav-sidebar-buttons"></div>
  </div>
  
  <section class="controls">
    <div class="search-container">
      <input id="search" class="search" type="search" placeholder="Rechercher un produit ou une section...">
      <button class="clear-search" id="clear-search">&times;</button>
    </div>
    <select id="sort">
      <option value="">Trier</option>
      <option value="price-asc">Prix croissant</option>
      <option value="price-desc">Prix d√©croissant</option>
    </select>
    <select id="section-filter">
      <option value="">Toutes les sections</option>
    </select>
  </section>
  <section id="catalogue">
    <div id="products-grid">
      <div class="loading">
        <div class="spinner"></div>
        <div>Chargement des produits...</div>
        <div class="loading-status" id="loading-status">Initialisation...</div>
      </div>
    </div>
  </section>
</main>

<div id="img-modal">
  <span id="close-modal">&times;</span>
  <img src="" alt="Produit">
</div>

<div class="admin-panel" id="admin-panel">
  <h3 id="admin-title">Espace administrateur
    <button id="admin-toggle">‚Äì</button>
  </h3>
  <div class="notice" id="admin-info">Connect√© en tant qu'administrateur</div>

  <div id="admin-content">
    <!-- Onglets -->
    <div class="admin-tabs">
      <button class="admin-tab active" data-tab="products">Produits</button>
      <button class="admin-tab" data-tab="sections">Sections</button>
    </div>

    <!-- Contenu des onglets -->
    <div id="products-tab" class="tab-content active">
      <h4>Gestion des produits</h4>
      <input id="name-input" placeholder="Nom du produit">
      <input id="price-input" placeholder="Prix (Fcfa)" inputmode="numeric">
      <textarea id="desc-input" placeholder="Description" rows="2"></textarea>
      <select id="section-select"></select>
      <div class="thumb-preview" id="preview"></div>
      <input id="file" type="file" accept="image/*">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="add-btn" class="btn">Ajouter / Modifier</button>
        <button id="cancel-edit" class="btn secondary small">Annuler</button>
      </div>
    </div>

    <div id="sections-tab" class="tab-content">
      <h4>Gestion des sections</h4>
      <input id="section-input" placeholder="Nom de la section">
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button id="add-section-btn" class="btn small">Ajouter / Modifier</button>
        <button id="clear-section-btn" class="btn secondary small">Annuler</button>
      </div>
      <div style="margin-top:12px">
        <strong style="font-size:14px;">Sections existantes :</strong>
        <ul id="sections-list" style="margin-top:6px;list-style:none;padding:0;"></ul>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid #eee">
      <button id="logout" class="btn secondary small">Se d√©connecter</button>
      <div class="muted" style="font-size:12px">Mot de passe : <strong id="pw-display">Laure1975</strong></div>
    </div>
  </div>
</div>

<footer>
  <div id="footer-line">¬© <span id="year"></span> Laura Shop's ‚Äî Commander via WhatsApp</div>
</footer>

<script>
// Configuration
const CONFIG = {
  whatsapp: '+237694484568',
  defaultPassword: 'Laure1975',
  shopName: "Laura Shop's"
};

// API endpoints
const API = {
  base: 'https://api-fugh.onrender.com',
  sections: 'https://api-fugh.onrender.com/sections',
  products: 'https://api-fugh.onrender.com/products'
};

// CACHE AGGRESSIF POUR AFFICHAGE INSTANTAN√â
let dataCache = {
  products: null,
  sections: null,
  lastFetch: 0
};

// PR√âCHARGEMENT IMM√âDIAT DU CACHE
(function preloadCache() {
  try {
    const cachedProducts = localStorage.getItem('laura_shop_products');
    const cachedSections = localStorage.getItem('laura_shop_sections');
    const cacheTime = localStorage.getItem('laura_shop_cache_time');
    
    if (cachedProducts && cachedSections && cacheTime) {
      dataCache.products = JSON.parse(cachedProducts);
      dataCache.sections = JSON.parse(cachedSections);
      dataCache.lastFetch = parseInt(cacheTime);
      console.log('‚ö° Cache pr√©charg√©:', { 
        products: dataCache.products.length,
        sections: dataCache.sections.length 
      });
    }
  } catch (e) {
    console.log('‚ùå Erreur pr√©chargement cache:', e);
  }
})();

// Utilitaires
const $ = s => document.querySelector(s);
const qs = s => Array.from(document.querySelectorAll(s));
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 8);

// Internationalisation
let LANG = 'fr';
const TEXT = {
  fr: { order: 'Commander sur WhatsApp', admin: 'Espace administrateur' },
  en: { order: 'Order on WhatsApp', admin: 'Admin Area' }
};
const t = k => TEXT[LANG][k] || k;

// Fonction de normalisation pour la recherche
const normalizeString = str => String(str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();

// FONCTION API ULTRA-OPTIMIS√âE AVEC CACHE INSTANTAN√â
async function apiGet(url, useCache = true) {
  const cacheKey = url.includes('products') ? 'products' : 'sections';
  
  // 1. CACHE MEMOIRE - Instantan√© (0ms)
  if (useCache && dataCache[cacheKey] && (Date.now() - dataCache.lastFetch < 1800000)) { // 30 minutes
    console.log('üì¶ Utilisation du cache m√©moire pour:', cacheKey);
    return dataCache[cacheKey];
  }

  // 2. CACHE LOCALSTORAGE - Tr√®s rapide (<10ms)
  try {
    const cached = localStorage.getItem(`laura_shop_${cacheKey}`);
    const cacheTime = localStorage.getItem(`laura_shop_cache_time`);
    
    if (useCache && cached && cacheTime && (Date.now() - parseInt(cacheTime) < 3600000)) { // 1 heure
      console.log('üíæ Utilisation du cache localStorage');
      dataCache[cacheKey] = JSON.parse(cached);
      dataCache.lastFetch = parseInt(cacheTime);
      return dataCache[cacheKey];
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erreur cache localStorage');
  }

  // 3. API - Lent (dernier recours)
  try {
    console.log('üåê Appel API pour:', cacheKey);
    updateLoadingStatus('Connexion √† l\'API...');
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    
    const r = await fetch(url, { 
      cache: 'no-store',
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!r.ok) throw new Error('fetch failed');
    const data = await r.json();
    
    // Sauvegarder dans le cache pour les prochaines fois
    dataCache[cacheKey] = data;
    dataCache.lastFetch = Date.now();
    
    try {
      localStorage.setItem(`laura_shop_${cacheKey}`, JSON.stringify(data));
      localStorage.setItem('laura_shop_cache_time', Date.now().toString());
    } catch (e) {
      console.log('‚ö†Ô∏è Impossible de sauvegarder dans localStorage');
    }
    
    return data;
  } catch (e) {
    console.error('‚ùå API GET error:', e);
    
    // 4. FALLBACK - Retourner le cache m√™me ancien
    if (dataCache[cacheKey]) {
      console.log('üîÑ Utilisation du cache (erreur API)');
      return dataCache[cacheKey];
    }
    
    // Dernier recours: localStorage m√™me ancien
    try {
      const cached = localStorage.getItem(`laura_shop_${cacheKey}`);
      if (cached) {
        console.log('üîÑ Utilisation du cache localStorage (erreur API)');
        return JSON.parse(cached);
      }
    } catch (e) {
      console.log('‚ùå Aucun cache disponible');
    }
    
    return [];
  }
}

// CHARGEMENT PARALL√àLE OPTIMIS√â
async function loadAllData() {
  console.log('üöÄ Chargement parall√®le des donn√©es...');
  try {
    const [products, sections] = await Promise.all([
      apiGet(API.products),
      apiGet(API.sections)
    ]);
    console.log('‚úÖ Donn√©es charg√©es:', { produits: products.length, sections: sections.length });
    return { products, sections };
  } catch (error) {
    console.error('‚ùå Erreur chargement donn√©es:', error);
    return { products: dataCache.products || [], sections: dataCache.sections || [] };
  }
}

// Fonctions pour les sections
async function loadSections() {
  return await apiGet(API.sections);
}

async function addSection(section) {
  const result = await apiPost(API.sections, section);
  invalidateCache();
  return result;
}

async function saveSection(section) {
  const result = await apiPut(`${API.sections}/${section.id}`, section);
  invalidateCache();
  return result;
}

async function deleteSectionById(id) {
  const result = await apiDelete(`${API.sections}/${id}`);
  invalidateCache();
  return result;
}

// Fonctions pour les produits
async function loadProducts() {
  return await apiGet(API.products);
}

async function addProduct(product) {
  const result = await apiPost(API.products, product);
  invalidateCache();
  return result;
}

async function saveProduct(product) {
  const result = await apiPut(`${API.products}/${product.id}`, product);
  invalidateCache();
  return result;
}

async function deleteProductById(id) {
  const result = await apiDelete(`${API.products}/${id}`);
  invalidateCache();
  return result;
}

// Fonctions API de base
async function apiPost(url, body) {
  try {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error('post failed');
    return await r.json();
  } catch (e) {
    console.error('API POST error:', e);
    throw e;
  }
}

async function apiPut(url, body) {
  try {
    const r = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error('put failed');
    return await r.json();
  } catch (e) {
    console.error('API PUT error:', e);
    throw e;
  }
}

async function apiDelete(url) {
  try {
    const r = await fetch(url, { method: 'DELETE' });
    if (!r.ok) throw new Error('delete failed');
    return true;
  } catch (e) {
    console.error('API DELETE error:', e);
    return false;
  }
}

// Invalider le cache apr√®s modifications
function invalidateCache() {
  dataCache.lastFetch = 0;
  try {
    localStorage.removeItem('laura_shop_cache_time');
  } catch (e) {}
}

// Mise √† jour du statut de chargement
function updateLoadingStatus(message) {
  const statusEl = $('#loading-status');
  if (statusEl) {
    statusEl.textContent = message;
  }
}

// Gestion de l'admin
function isAdmin() {
  return sessionStorage.getItem('admin') === '1';
}

function setAdmin(v) {
  sessionStorage.setItem('admin', v ? '1' : '0');
  updateAdminUI();
}

function showAdminButtons() {
  qs('.admin-actions').forEach(btn => btn.style.display = 'flex');
  setTimeout(() => {
    renderProducts();
  }, 0);
}

function hideAdminButtons() {
  qs('.admin-actions').forEach(btn => btn.style.display = 'none');
}

// Variables d'√©tat
let editingId = null;
let editingSectionId = null;
let adminPanelMinimized = false;

// Gestion des onglets admin
function initAdminTabs() {
  const tabs = qs('.admin-tab');
  const tabContents = qs('.tab-content');
  
  tabs.forEach(tab => {
    tab.onclick = () => {
      // D√©sactiver tous les onglets
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      // Activer l'onglet cliqu√©
      tab.classList.add('active');
      const tabId = tab.dataset.tab + '-tab';
      $(`#${tabId}`).classList.add('active');
    };
  });
}

// Fonction pour afficher les sections
async function renderSections() {
  try {
    const list = $('#sections-list');
    if (!list) return;

    list.innerHTML = '';
    let sections = await loadSections();
    
    sections.sort((a, b) => {
      const nameA = (a.name || '').toLowerCase();
      const nameB = (b.name || '').toLowerCase();
      return nameA.localeCompare(nameB);
    });

    // Liste admin
    sections.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>${s.name}</span>
        <span>
          <button class="small btn secondary edit-section" data-id="${s._id || s.id}">Edit</button>
          <button class="small btn secondary del-section" data-id="${s._id || s.id}">Suppr</button>
        </span>
      `;
      list.appendChild(li);
    });

    // √âv√©nements pour les boutons
    qs('.edit-section').forEach(b => b.onclick = () => startEditSection(b.dataset.id));
    qs('.del-section').forEach(b => b.onclick = () => handleDeleteSection(b.dataset.id));

    // Mise √† jour des s√©lecteurs
    await updateSectionSelects(sections);
    buildSectionNav(sections);
    await renderSectionFilter();
  } catch (error) {
    console.error('Error in renderSections:', error);
  }
}

async function updateSectionSelects(sections) {
  const sel = $('#section-select');
  if (!sel) return;

  sel.innerHTML = '<option value="">-- Choisir une section --</option>';
  
  const sortedSections = [...sections].sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    return nameA.localeCompare(nameB);
  });
  
  sortedSections.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s._id || s.id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

async function renderSectionFilter() {
  const sel = $('#section-filter');
  if (!sel) return;

  sel.innerHTML = '<option value="">Toutes les sections</option>';
  let sections = await loadSections();
  
  const sortedSections = [...sections].sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    return nameA.localeCompare(nameB);
  });
  
  sortedSections.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s._id || s.id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

// Gestion des sections
function clearSectionForm() {
  editingSectionId = null;
  $('#section-input').value = '';
}

async function addOrUpdateSection() {
  try {
    const name = $('#section-input').value.trim();
    if (!name) return alert('Nom de section requis');

    if (editingSectionId) {
      await saveSection({ id: editingSectionId, name });
    } else {
      await addSection({ name });
    }

    clearSectionForm();
    await renderSections();
    await renderProducts();
  } catch (error) {
    console.error('Error in addOrUpdateSection:', error);
    alert('Erreur lors de l\'op√©ration sur la section');
  }
}

async function startEditSection(id) {
  try {
    const sections = await loadSections();
    const s = sections.find(x => (x._id || x.id) === id);
    if (!s) return;

    editingSectionId = id;
    $('#section-input').value = s.name;
    
    // Basculer vers l'onglet sections
    qs('.admin-tab').forEach(t => t.classList.remove('active'));
    qs('.tab-content').forEach(c => c.classList.remove('active'));
    $('.admin-tab[data-tab="sections"]').classList.add('active');
    $('#sections-tab').classList.add('active');
    
    // S'assurer que le panneau admin est ouvert et d√©velopp√©
    expandAdminPanel();
  } catch (error) {
    console.error('Error in startEditSection:', error);
  }
}

async function handleDeleteSection(id) {
  if (!confirm('Supprimer cette section et tous ses articles ?')) return;

  try {
    await deleteSectionById(id);

    // Supprimer les produits de cette section
    const products = await loadProducts();
    for (const p of products) {
      if (p.sectionId === id) {
        await deleteProductById(p._id || p.id);
      }
    }

    await renderSections();
    await renderProducts();
  } catch (error) {
    console.error('Error in handleDeleteSection:', error);
    alert('Erreur lors de la suppression de la section');
  }
}

// Gestion des produits
function clearForm() {
  editingId = null;
  $('#name-input').value = '';
  $('#price-input').value = '';
  $('#desc-input').value = '';
  $('#file').value = '';
  $('#preview').innerHTML = '';
  $('#section-select').value = '';
}

async function addOrUpdate() {
  try {
    const n = $('#name-input').value.trim();
    const pr = parseFloat($('#price-input').value) || 0;
    const d = $('#desc-input').value.trim();
    const secId = $('#section-select').value;

    if (!n) return alert('Nom requis');
    if (!secId || secId === '' || secId === 'undefined') {
      return alert('Section requise - Veuillez s√©lectionner une section valide');
    }

    const formData = new FormData();
    formData.append('name', n);
    formData.append('price', pr.toString());
    formData.append('description', d);
    formData.append('sectionId', secId);

    const f = $('#file').files[0];
    if (f) {
      formData.append('image', f);
    }

    let result;
    if (editingId) {
      const response = await fetch(`${API.products}/${editingId}`, {
        method: 'PUT',
        body: formData
      });
      if (!response.ok) throw new Error('Erreur lors de la modification');
      result = await response.json();
    } else {
      const response = await fetch(API.products, {
        method: 'POST',
        body: formData
      });
      if (!response.ok) throw new Error('Erreur lors de l\'ajout');
      result = await response.json();
    }

    clearForm();
    invalidateCache();
    
    // Recharger les donn√©es
    setTimeout(async () => {
      await loadAllData();
      await renderProducts();
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error in addOrUpdate:', error);
    alert('Erreur ajout / modification produit');
  }
}

// Fonctions pour g√©rer le panneau admin
function expandAdminPanel() {
  $('#admin-content').style.display = 'block';
  $('#admin-toggle').textContent = '‚Äì';
  adminPanelMinimized = false;
}

function minimizeAdminPanel() {
  $('#admin-content').style.display = 'none';
  $('#admin-toggle').textContent = '+';
  adminPanelMinimized = true;
}

async function startEdit(id) {
  try {
    const products = await loadProducts();
    const p = products.find(x => (x._id || x.id) === id);
    if (!p) return;

    editingId = id;
    $('#name-input').value = p.name || '';
    $('#price-input').value = p.price || '';
    $('#desc-input').value = p.description || '';
    $('#section-select').value = p.sectionId || '';

    if (p.image) {
      $('#preview').innerHTML = `<img src="${p.image}" style="max-width:100%;max-height:100%">`;
    }

    // Basculer vers l'onglet produits
    qs('.admin-tab').forEach(t => t.classList.remove('active'));
    qs('.tab-content').forEach(c => c.classList.remove('active'));
    $('.admin-tab[data-tab="products"]').classList.add('active');
    $('#products-tab').classList.add('active');

    // S'assurer que le panneau admin est ouvert et d√©velopp√©
    expandAdminPanel();

    if (window.innerWidth <= 600) {
      $('#admin-panel').scrollIntoView({ behavior: 'smooth' });
    }
  } catch (error) {
    console.error('Error in startEdit:', error);
  }
}

async function handleDeleteProduct(id) {
  if (!confirm('Supprimer cet article ?')) return;

  try {
    await deleteProductById(id);
    invalidateCache();
    await renderProducts();
  } catch (error) {
    console.error('Error in handleDeleteProduct:', error);
    alert('Erreur lors de la suppression du produit');
  }
}

// Fonction pour g√©n√©rer l'URL WhatsApp
function whatsappUrl(p) {
  const base = 'https://wa.me/' + CONFIG.whatsapp.replace(/\D/g, '');
  const productUrl = `${window.location.origin}${window.location.pathname}#product-${encodeURIComponent(p.name.toLowerCase().replace(/\s+/g, '-'))}`;
  const msg = LANG === 'fr'
    ? `Bonjour Mme Laure, je souhaite commander ${p.name} au prix de ${p.price.toLocaleString()} Fcfa.\nVoir le produit ici : ${productUrl}`
    : `Hello, I want to order ${p.name} for ${p.price.toLocaleString()} Fcfa.\nSee the product here: ${productUrl}`;
  return base + '?text=' + encodeURIComponent(msg);
}

// Navigation par sections
function buildSectionNav(sections) {
  const nav = $('#section-nav');
  const sidebarButtons = $('#section-nav-sidebar-buttons');
  
  if (!nav || !sidebarButtons) return;

  nav.innerHTML = '';
  sidebarButtons.innerHTML = '';

  // Bouton "Toutes"
  const allBtn = document.createElement('button');
  allBtn.textContent = 'Toutes';
  allBtn.classList.add('active');
  allBtn.onclick = () => {
    qs('#section-nav button').forEach(b => b.classList.remove('active'));
    qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
    allBtn.classList.add('active');
    $('#section-filter').value = '';
    renderProducts();
    closeSidebar();
  };
  nav.appendChild(allBtn);

  // Bouton "Toutes" pour le menu lat√©ral
  const allBtnSidebar = document.createElement('button');
  allBtnSidebar.textContent = 'Toutes';
  allBtnSidebar.classList.add('active');
  allBtnSidebar.onclick = () => {
    qs('#section-nav button').forEach(b => b.classList.remove('active'));
    qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
    allBtnSidebar.classList.add('active');
    $('#section-filter').value = '';
    renderProducts();
    closeSidebar();
  };
  sidebarButtons.appendChild(allBtnSidebar);

  const sortedSections = [...sections].sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    return nameA.localeCompare(nameB);
  });

  // Boutons pour chaque section
  sortedSections.forEach(s => {
    const sectionId = s._id || s.id;
    const sectionName = s.name;

    // Bouton pour la navigation principale
    const btn = document.createElement('button');
    btn.textContent = sectionName;
    btn.setAttribute('data-section-id', sectionId);
    
    btn.onclick = () => {
      qs('#section-nav button').forEach(b => b.classList.remove('active'));
      qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      $('#section-filter').value = sectionId;
      renderProducts().then(() => {
        const sectionElement = document.querySelector(`[data-section="${sectionId}"]`);
        if (sectionElement) {
          sectionElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
          });
        }
      });
    };
    
    nav.appendChild(btn);

    // Bouton pour le menu lat√©ral
    const btnSidebar = document.createElement('button');
    btnSidebar.textContent = sectionName;
    btnSidebar.setAttribute('data-section-id', sectionId);
    
    btnSidebar.onclick = () => {
      qs('#section-nav button').forEach(b => b.classList.remove('active'));
      qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
      btnSidebar.classList.add('active');
      
      $('#section-filter').value = sectionId;
      renderProducts().then(() => {
        const sectionElement = document.querySelector(`[data-section="${sectionId}"]`);
        if (sectionElement) {
          sectionElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
          });
        }
      });
      
      closeSidebar();
    };
    
    sidebarButtons.appendChild(btnSidebar);
  });
}

// Gestion du menu lat√©ral
function openSidebar() {
  $('#section-nav-overlay').style.display = 'block';
  $('#section-nav-sidebar').classList.add('show');
}

function closeSidebar() {
  $('#section-nav-overlay').style.display = 'none';
  $('#section-nav-sidebar').classList.remove('show');
}

// Synchroniser la navigation et le select de filtre
function syncSectionFilter() {
  const sectionFilter = $('#section-filter').value;
  const navButtons = qs('#section-nav button');
  const sidebarButtons = qs('#section-nav-sidebar-buttons button');
  
  // Retirer toutes les classes active
  navButtons.forEach(btn => btn.classList.remove('active'));
  sidebarButtons.forEach(btn => btn.classList.remove('active'));
  
  if (!sectionFilter) {
    // Activer "Toutes"
    navButtons[0]?.classList.add('active');
    sidebarButtons[0]?.classList.add('active');
  } else {
    // Activer le bouton correspondant
    const activeBtn = navButtons.find(btn => 
      btn.getAttribute('data-section-id') === sectionFilter
    );
    if (activeBtn) {
      activeBtn.classList.add('active');
    }
    
    const activeSidebarBtn = sidebarButtons.find(btn => 
      btn.getAttribute('data-section-id') === sectionFilter
    );
    if (activeSidebarBtn) {
      activeSidebarBtn.classList.add('active');
    }
  }
}

// Optimisations mobiles
function initMobileOptimizations() {
  let isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  
  if (isTouchDevice) {
    document.body.classList.add('touch-device');
  }
  
  window.addEventListener('resize', () => {
    if (window.innerHeight < 500) {
      document.body.classList.add('keyboard-open');
    } else {
      document.body.classList.remove('keyboard-open');
    }
  });
}

function optimizeProductImages() {
  qs('.thumb img').forEach(img => {
    img.loading = 'lazy';
    
    if (window.innerWidth < 768) {
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
    }
  });
}

// FONCTION DE RECHERCHE CORRIG√âE - PAS DE DOUBLONS
function matchesSearch(product, sectionName, searchWords) {
  const productText = normalizeString((product.name || '') + ' ' + (product.description || ''));
  const sectionText = normalizeString(sectionName || '');
  
  return searchWords.every(word => 
    productText.includes(word) || sectionText.includes(word)
  );
}

// AFFICHAGE DES PRODUITS OPTIMIS√â
async function renderProducts(products = null, sections = null) {
  try {
    console.log('üîÑ D√©but de renderProducts');
    const grid = $('#products-grid');
    if (!grid) return;

    // AFFICHAGE INSTANTAN√â AVEC CACHE
    if (dataCache.products && dataCache.sections) {
      console.log('‚ö° Affichage instantan√© depuis le cache');
      products = dataCache.products;
      sections = dataCache.sections;
      updateLoadingStatus('Affichage des produits...');
    } else if (!products || !sections) {
      updateLoadingStatus('Chargement des donn√©es...');
      const data = await loadAllData();
      products = data.products;
      sections = data.sections;
    }

    // Masquer l'indicateur de chargement
    const loadingEl = $('.loading');
    if (loadingEl) loadingEl.style.display = 'none';

    grid.innerHTML = '';

    const q = $('#search').value.trim();
    const sectionFilter = $('#section-filter').value;
    const sortVal = $('#sort').value;

    // Diviser la recherche en mots individuels
    const searchWords = q ? normalizeString(q).split(/\s+/).filter(word => word.length > 0) : [];

    // Trier les produits
    let sortedProducts = [...products];
    if (sortVal === 'price-asc') {
      sortedProducts.sort((a, b) => a.price - b.price);
    } else if (sortVal === 'price-desc') {
      sortedProducts.sort((a, b) => b.price - a.price);
    } else {
      sortedProducts.sort((a, b) => {
        const idA = a._id || a.id;
        const idB = b._id || b.id;
        return idB.localeCompare(idA);
      });
    }

    // Trier les sections par date
    sections.sort((a, b) => {
      const dateA = new Date(a.updatedAt || a.createdAt || a._id);
      const dateB = new Date(b.updatedAt || b.createdAt || b._id);
      return dateB - dateA;
    });

    // CORRECTION : Utiliser un Set pour √©viter les doublons
    const displayedProductIds = new Set();
    let hasDisplayedProducts = false;

    // Afficher par section
    for (const section of sections) {
      const sectionId = section._id || section.id;
      const sectionName = section.name;

      // Appliquer le filtre de section
      if (sectionFilter && sectionId !== sectionFilter) {
        continue;
      }

      let sectProducts = sortedProducts.filter(p => (p.sectionId || p.sectionId) === sectionId);

      // Appliquer la recherche et √©viter les doublons
      if (searchWords.length > 0) {
        sectProducts = sectProducts.filter(p => {
          const productId = p._id || p.id;
          if (displayedProductIds.has(productId)) {
            return false;
          }
          
          const matches = matchesSearch(p, sectionName, searchWords);
          if (matches) {
            displayedProductIds.add(productId);
          }
          return matches;
        });
      } else {
        sectProducts = sectProducts.filter(p => {
          const productId = p._id || p.id;
          if (displayedProductIds.has(productId)) {
            return false;
          }
          displayedProductIds.add(productId);
          return true;
        });
      }

      if (sectProducts.length === 0) {
        continue;
      }

      const secDiv = document.createElement('div');
      secDiv.setAttribute('data-section', sectionId);
      secDiv.innerHTML = `<h3 id="section-${sectionId}">${sectionName}</h3>`;

      const sectGrid = document.createElement('div');
      sectGrid.className = 'grid';

      for (const product of sectProducts) {
        const card = document.createElement('article');
        card.className = 'card';

        const imageSrc = product.image || '';
        const imageHtml = imageSrc
          ? `<img src="${imageSrc}" alt="${product.name}">`
          : '<div class="muted">Aucune image</div>';

        const productId = product._id || product.id;
        
        card.innerHTML = `
          <div class="thumb">${imageHtml}</div>
          <div class="card-body">
            <div class="name">${product.name}</div>
            <div class="desc">${product.description || ''}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="price">${(product.price || 0).toLocaleString()} Fcfa</div>
              <div class="card-actions">
                <a class="small btn" href="${whatsappUrl(product)}" target="_blank">${t('order')}</a>
                ${isAdmin() ? `
                  <div class="admin-actions">
                    <button class="small btn secondary edit" data-id="${productId}">Edit</button>
                    <button class="small btn secondary del" data-id="${productId}">Suppr</button>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        sectGrid.appendChild(card);
        hasDisplayedProducts = true;
      }

      secDiv.appendChild(sectGrid);
      grid.appendChild(secDiv);
    }

    // CORRECTION : Produits sans section uniquement sans recherche
    if (!sectionFilter && !q) {
      const productsWithoutSection = sortedProducts.filter(p => {
        const productId = p._id || p.id;
        if (displayedProductIds.has(productId)) {
          return false;
        }
        return !p.sectionId || p.sectionId === 'undefined' || p.sectionId === 'null';
      });

      let filteredProductsWithoutSection = productsWithoutSection;
      if (searchWords.length > 0) {
        filteredProductsWithoutSection = [];
      }

      if (filteredProductsWithoutSection.length > 0) {
        const secDiv = document.createElement('div');
        secDiv.setAttribute('data-section', 'undefined');
        secDiv.innerHTML = `<h3 id="section-undefined">‚ö†Ô∏è Produits non class√©s</h3>`;
        const sectGrid = document.createElement('div');
        sectGrid.className = 'grid';

        for (const product of filteredProductsWithoutSection) {
          const card = document.createElement('article');
          card.className = 'card';

          const imageSrc = product.image || '';
          const imageHtml = imageSrc
            ? `<img src="${imageSrc}" alt="${product.name}">`
            : '<div class="muted">Aucune image</div>';

          const productId = product._id || product.id;

          card.innerHTML = `
            <div class="thumb">${imageHtml}</div>
            <div class="card-body">
              <div class="name">${product.name}</div>
              <div class="desc">${product.description || ''}</div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="price">${(product.price || 0).toLocaleString()} Fcfa</div>
                <div class="card-actions">
                  <a class="small btn" href="${whatsappUrl(product)}" target="_blank">${t('order')}</a>
                  ${isAdmin() ? `
                    <div class="admin-actions">
                      <button class="small btn secondary edit" data-id="${productId}">Edit</button>
                      <button class="small btn secondary del" data-id="${productId}">Suppr</button>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          `;

          sectGrid.appendChild(card);
          hasDisplayedProducts = true;
        }

        secDiv.appendChild(sectGrid);
        grid.appendChild(secDiv);
      }
    }

    // Message si aucun produit trouv√©
    if (!hasDisplayedProducts) {
      grid.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--muted);">
          <h3>Aucun produit trouv√©</h3>
          <p>Essayez de modifier vos crit√®res de recherche ou de filtre</p>
        </div>
      `;
    }

    // √âv√©nements pour les images
    qs('.thumb').forEach(thumb => {
      thumb.onclick = () => {
        const img = thumb.querySelector('img');
        if (img && img.src) {
          $('#img-modal img').src = img.src;
          $('#img-modal').style.display = 'flex';
        }
      };
    });

    // √âv√©nements pour les boutons admin
    qs('.edit').forEach(btn => {
      btn.onclick = () => startEdit(btn.dataset.id);
    });

    qs('.del').forEach(btn => {
      btn.onclick = () => handleDeleteProduct(btn.dataset.id);
    });

    // Optimiser les images apr√®s rendu
    setTimeout(optimizeProductImages, 100);

    console.log('‚úÖ renderProducts termin√©');

  } catch (error) {
    console.error('‚ùå Error in renderProducts:', error);
  }
}

// Mise √† jour de l'interface admin
function updateAdminUI() {
  const panel = $('#admin-panel');
  const adminBtn = $('#admin-btn');

  if (!panel || !adminBtn) return;

  if (isAdmin()) {
    panel.classList.add('show');
    adminBtn.style.display = 'none';
    showAdminButtons();
  } else {
    panel.classList.remove('show');
    adminBtn.style.display = 'inline-block';
    hideAdminButtons();
  }
}

// Configuration des √©v√©nements
function setupEventListeners() {
  // √âv√©nements pour la navigation compacte
  $('#section-nav-toggle').onclick = openSidebar;
  $('#close-sidebar').onclick = closeSidebar;
  $('#section-nav-overlay').onclick = closeSidebar;

  // √âv√©nements pour le bouton de suppression de recherche
  $('#clear-search').onclick = () => {
    $('#search').value = '';
    renderProducts();
  };

  // Afficher/masquer le bouton de suppression en fonction du contenu
  $('#search').oninput = function() {
    if (this.value.trim() !== '') {
      $('#clear-search').style.display = 'block';
    } else {
      $('#clear-search').style.display = 'none';
    }
    renderProducts();
  };

  $('.logo').onclick = () => {
    const pw = prompt("R√©serv√© √† l'administrateur");
    if (pw === CONFIG.defaultPassword) {
      setAdmin(true);
    } else {
      alert('Mot de passe incorrect');
    }
  };

  $('#logout').onclick = () => { 
    setAdmin(false); 
  };

  $('#add-btn').onclick = addOrUpdate;
  $('#cancel-edit').onclick = clearForm;
  $('#add-section-btn').onclick = addOrUpdateSection;
  $('#clear-section-btn').onclick = clearSectionForm;

  $('#sort').onchange = renderProducts;
  $('#section-filter').onchange = () => {
    syncSectionFilter();
    renderProducts();
  };

  // Toggle du panel admin
  $('#admin-toggle').onclick = () => {
    if (adminPanelMinimized) {
      expandAdminPanel();
    } else {
      minimizeAdminPanel();
    }
  };

  // Preview d'image
  $('#file').onchange = e => {
    const f = e.target.files[0];
    if (!f) return;

    const reader = new FileReader();
    reader.onload = () => {
      $('#preview').innerHTML = `<img src="${reader.result}">`;
    };
    reader.readAsDataURL(f);
  };

  // Changement de langue
  $('#lang-fr').onclick = () => { LANG = 'fr'; renderProducts(); };
  $('#lang-en').onclick = () => { LANG = 'en'; renderProducts(); };

  // Modal d'image
  $('#close-modal').onclick = () => {
    $('#img-modal').style.display = 'none';
  };
}

// Initialisation optimis√©e
document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Ann√©e du footer
    const yearEl = $('#year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    // Initialisation rapide de l'interface
    initMobileOptimizations();
    initAdminTabs();
    setupEventListeners();
    
    updateLoadingStatus('Pr√©paration de l\'affichage...');

    // AFFICHAGE INSTANTAN√â - Utiliser le cache d'abord
    if (dataCache.products && dataCache.sections) {
      console.log('üöÄ Affichage instantan√© depuis le cache');
      await renderSections();
      await renderProducts(dataCache.products, dataCache.sections);
      updateLoadingStatus('Donn√©es charg√©es depuis le cache');
    } else {
      updateLoadingStatus('Chargement des donn√©es...');
      // Charger les donn√©es en arri√®re-plan
      loadAllData().then(async (data) => {
        await renderSections();
        await renderProducts(data.products, data.sections);
      });
    }

    updateAdminUI();

    console.log('‚úÖ Site initialis√© avec succ√®s');

    // V√©rifier si d√©j√† admin
    if (isAdmin()) updateAdminUI();

  } catch (error) {
    console.error('Error during initialization:', error);
    updateLoadingStatus('Erreur de chargement');
  }
});
</script>
</body>
</html>
