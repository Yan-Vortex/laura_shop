<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laura Shop's ‚Äî Catalogue</title>
<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --accent:#8e44ad;
  --muted:#666;
  --glass: rgba(255,255,255,0.6);
  --radius:12px;
  --shadow:0 6px 18px rgba(19,24,33,0.08);
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
body{margin:0;background:linear-gradient(180deg,#f7fbfb 0%,var(--bg) 100%);color:#111}
header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;background:transparent}
.brand{display:flex;gap:12px;align-items:center;position:relative}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#a569bd);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;cursor:pointer;position:relative}
#admin-btn{position:absolute;top:0;left:0;width:44px;height:44px;opacity:0;cursor:pointer;z-index:2}
.title{font-size:18px;font-weight:700}
nav{display:flex;gap:10px;align-items:center}
button, .btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid #e6e6e6}

.container{max-width:1100px;margin:26px auto;padding:0 18px}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:18px}
.search{flex:1;min-width:160px}
input[type=text], input[type=search], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid #e7e7e7}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;position:relative}
.thumb{height:160px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;cursor:pointer}
.thumb img{max-width:100%;max-height:100%;object-fit:contain}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
.name{font-weight:700}
.desc{color:var(--muted);font-size:13px;min-height:36px}
.price{font-weight:800;font-size:16px}
.card-actions{display:flex;gap:8px;align-items:center}
.small{padding:8px 10px;border-radius:10px;font-size:13px}

.card-actions a {
  text-decoration: none;
}

footer{padding:20px;text-align:center;color:var(--muted);font-size:14px}

.admin-panel{position:fixed;right:18px;bottom:18px;background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);width:340px;max-width:calc(100% - 36px);display:none;z-index:60;transition:all 0.3s ease;overflow:hidden;}
.admin-panel.show{display:block}
.admin-panel h3{margin:0 0 8px 0;position:relative;padding-right:32px;}
.admin-panel h3 button{position:absolute;top:0;right:0;width:28px;height:28px;background:var(--accent);border:none;border-radius:50%;color:#fff;cursor:pointer;font-weight:bold;font-size:18px;display:flex;align-items:center;justify-content:center;}
.thumb-preview{width:84px;height:84px;border-radius:10px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:8px}

@media (max-width:600px){.thumb{height:140px}.grid{grid-template-columns:repeat(2,1fr);}}

@media (min-width:601px) and (max-width:900px){.grid{grid-template-columns:repeat(3,1fr);} }
@media (min-width:901px){.grid{grid-template-columns:repeat(4,1fr);} }

.lang-toggle{display:flex;gap:6px}
.chip{background:var(--glass);padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);cursor:pointer}

.notice{padding:10px;border-radius:10px;background:#fff;border:1px solid #eee;margin-bottom:12px}
.muted{color:var(--muted)}

#img-modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);align-items:center;justify-content:center}
#img-modal img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 0 20px #000}
#img-modal span{position:absolute;top:20px;right:30px;color:#fff;font-size:32px;cursor:pointer;font-weight:bold}

.admin-actions{display:flex;gap:6px;align-items:center}
.admin-actions .small{padding:6px 8px;border-radius:10px;font-size:13px}

@media (max-width:600px){
  .admin-actions .small{padding:10px 12px;font-size:15px;border-radius:12px}
  .card .admin-actions{position:absolute;right:10px;bottom:12px;flex-direction:row-reverse;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));padding:6px;border-radius:999px;box-shadow:var(--shadow)}
  .card .admin-actions .small{box-shadow:none}
  .card{padding-bottom:18px}
}

@media (min-width:601px){
  .card .admin-actions{position:static;padding:0;background:transparent}
}

#products-grid > div > h3{
  margin:16px 0 12px 0;
  font-size:20px;
  font-weight:700;
  color:var(--accent);
  text-transform: uppercase;
  border-bottom: 2px solid var(--accent);
  padding-bottom:6px;
  position:relative;
}
#products-grid > div > h3::after{
  content:'';
  position:absolute;
  left:0; bottom:-2px;
  width:50px;
  height:4px;
  background:var(--accent);
  border-radius:2px;
}

#products-grid > div{
  margin-bottom:28px;
  padding-bottom:12px;
  border-bottom:1px solid #eaeaea;
}

/* Styles pour la navigation compacte */
#section-nav-container {
  position: relative;
  margin: 12px 0 24px 0;
}

#section-nav {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  transition: all 0.3s ease;
}

#section-nav button {
  background: transparent;
  color: var(--accent);
  border: 1px solid rgba(142,68,173,0.15);
  padding: 8px 12px;
  border-radius: 999px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

#section-nav button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

#section-nav button:hover:not(.active) {
  background: rgba(142,68,173,0.1);
}

/* Bouton menu d√©roulant pour petits √©crans */
#section-nav-toggle {
  display: none;
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 16px;
  margin-bottom: 8px;
}

/* Menu lat√©ral pour les sections */
#section-nav-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 100;
}

#section-nav-sidebar {
  position: fixed;
  top: 0;
  left: -300px;
  width: 280px;
  height: 100%;
  background: white;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  z-index: 101;
  transition: left 0.3s ease;
  padding: 20px;
  overflow-y: auto;
}

#section-nav-sidebar.show {
  left: 0;
}

#section-nav-sidebar h3 {
  margin-top: 0;
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 10px;
}

#section-nav-sidebar-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 15px;
}

#section-nav-sidebar-buttons button {
  background: transparent;
  color: var(--accent);
  border: 1px solid rgba(142,68,173,0.15);
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s ease;
}

#section-nav-sidebar-buttons button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

#section-nav-sidebar-buttons button:hover:not(.active) {
  background: rgba(142,68,173,0.1);
}

#close-sidebar {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

/* Styles responsifs pour la navigation */
@media (max-width: 768px) {
  #section-nav {
    display: none;
  }
  
  #section-nav-toggle {
    display: inline-block;
  }
  
  #section-nav.show-on-mobile {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
}

@media (min-width: 769px) {
  #section-nav-overlay,
  #section-nav-sidebar {
    display: none !important;
  }
}

/* Styles pour les onglets admin */
.admin-tabs {
  display: flex;
  border-bottom: 1px solid #e7e7e7;
  margin-bottom: 12px;
}

.admin-tab {
  flex: 1;
  padding: 8px 12px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-size: 13px;
  color: var(--muted);
  transition: all 0.2s ease;
}

.admin-tab:hover {
  color: var(--accent);
}

.admin-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
  font-weight: 600;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Ajustements pour le contenu des onglets */
#products-tab input,
#products-tab textarea,
#products-tab select {
  margin-bottom: 8px;
  width: 100%;
}

#sections-tab input {
  margin-bottom: 8px;
  width: 100%;
}

#sections-list {
  max-height: 150px;
  overflow-y: auto;
  border: 1px solid #e7e7e7;
  border-radius: var(--radius);
  padding: 8px;
  margin-top: 8px;
  background: #f9f9f9;
}

#sections-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
  padding: 6px 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid #f0f0f0;
  font-size: 13px;
}

#sections-list li:last-child {
  margin-bottom: 0;
}

/* Pour les √©crans tr√®s petits */
@media (max-width: 400px) {
  .admin-panel {
    width: 320px;
    right: 10px;
    bottom: 10px;
  }
  
  #sections-list {
    max-height: 100px;
  }
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">LS
      <button id="admin-btn" class="btn secondary"></button>
    </div>
    <div>
      <div class="title" id="shop-name">Laura Shop's</div>
      <div class="muted" id="shop-sub">Marketplace</div>
    </div>
  </div>
  <nav>
    <div class="lang-toggle">
      <div class="chip" id="lang-fr">FR</div>
      <div class="chip" id="lang-en">EN</div>
    </div>
  </nav>
</header>

<main class="container">
  <div id="section-nav-container">
    <button id="section-nav-toggle">...</button>
    <div id="section-nav"></div>
  </div>
  
  <!-- Menu lat√©ral pour mobile -->
  <div id="section-nav-overlay"></div>
  <div id="section-nav-sidebar">
    <button id="close-sidebar">&times;</button>
    <h3>Sections</h3>
    <div id="section-nav-sidebar-buttons"></div>
  </div>
  
  <section class="controls">
    <input id="search" class="search" type="search" placeholder="Rechercher un produit ou une section...">
    <select id="sort">
      <option value="">Trier</option>
      <option value="price-asc">Prix croissant</option>
      <option value="price-desc">Prix d√©croissant</option>
    </select>
    <select id="section-filter">
      <option value="">Toutes les sections</option>
    </select>
  </section>
  <section id="catalogue">
    <div id="products-grid"></div>
  </section>
</main>

<div id="img-modal">
  <span id="close-modal">&times;</span>
  <img src="" alt="Produit">
</div>

<div class="admin-panel" id="admin-panel">
  <h3 id="admin-title">Espace administrateur
    <button id="admin-toggle">‚Äì</button>
  </h3>
  <div class="notice" id="admin-info">Connect√© en tant qu'administrateur</div>

  <div id="admin-content">
    <!-- Onglets -->
    <div class="admin-tabs">
      <button class="admin-tab active" data-tab="products">Produits</button>
      <button class="admin-tab" data-tab="sections">Sections</button>
    </div>

    <!-- Contenu des onglets -->
    <div id="products-tab" class="tab-content active">
      <h4>Gestion des produits</h4>
      <input id="name-input" placeholder="Nom du produit">
      <input id="price-input" placeholder="Prix (Fcfa)" inputmode="numeric">
      <textarea id="desc-input" placeholder="Description" rows="2"></textarea>
      <select id="section-select"></select>
      <div class="thumb-preview" id="preview"></div>
      <input id="file" type="file" accept="image/*">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="add-btn" class="btn">Ajouter / Modifier</button>
        <button id="cancel-edit" class="btn secondary small">Annuler</button>
      </div>
    </div>

    <div id="sections-tab" class="tab-content">
      <h4>Gestion des sections</h4>
      <input id="section-input" placeholder="Nom de la section">
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button id="add-section-btn" class="btn small">Ajouter / Modifier</button>
        <button id="clear-section-btn" class="btn secondary small">Annuler</button>
      </div>
      <div style="margin-top:12px">
        <strong style="font-size:14px;">Sections existantes :</strong>
        <ul id="sections-list" style="margin-top:6px;list-style:none;padding:0;"></ul>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid #eee">
      <button id="logout" class="btn secondary small">Se d√©connecter</button>
      <div class="muted" style="font-size:12px">Mot de passe : <strong id="pw-display">Laure1975</strong></div>
    </div>
  </div>
</div>

<footer>
  <div id="footer-line">¬© <span id="year"></span> Laura Shop's ‚Äî Commander via WhatsApp</div>
</footer>

<script>
// Configuration
const CONFIG = {
  whatsapp: '+237694484568',
  defaultPassword: 'Laure1975',
  shopName: "Laura Shop's"
};

// API endpoints
const API = {
  base: 'https://api-fugh.onrender.com',
  sections: 'https://api-fugh.onrender.com/sections',
  products: 'https://api-fugh.onrender.com/products'
};

// Utilitaires
const $ = s => document.querySelector(s);
const qs = s => Array.from(document.querySelectorAll(s));
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 8);

// Internationalisation
let LANG = 'fr';
const TEXT = {
  fr: { order: 'Commander sur WhatsApp', admin: 'Espace administrateur' },
  en: { order: 'Order on WhatsApp', admin: 'Admin Area' }
};
const t = k => TEXT[LANG][k] || k;

// Fonction de normalisation pour la recherche
const normalizeString = str => String(str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();

// Fonctions API
async function apiGet(url) {
  try {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('fetch failed');
    return await r.json();
  } catch (e) {
    console.error('API GET error:', e);
    return [];
  }
}

async function apiPost(url, body) {
  try {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error('post failed');
    return await r.json();
  } catch (e) {
    console.error('API POST error:', e);
    throw e;
  }
}

async function apiPut(url, body) {
  try {
    const r = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error('put failed');
    return await r.json();
  } catch (e) {
    console.error('API PUT error:', e);
    throw e;
  }
}

async function apiDelete(url) {
  try {
    const r = await fetch(url, { method: 'DELETE' });
    if (!r.ok) throw new Error('delete failed');
    return true;
  } catch (e) {
    console.error('API DELETE error:', e);
    return false;
  }
}

// Fonctions pour les sections
async function loadSections() {
  return await apiGet(API.sections);
}

async function addSection(section) {
  return await apiPost(API.sections, section);
}

async function saveSection(section) {
  return await apiPut(`${API.sections}/${section.id}`, section);
}

async function deleteSectionById(id) {
  return await apiDelete(`${API.sections}/${id}`);
}

// Fonctions pour les produits
async function loadProducts() {
  return await apiGet(API.products);
}

async function addProduct(product) {
  return await apiPost(API.products, product);
}

async function saveProduct(product) {
  return await apiPut(`${API.products}/${product.id}`, product);
}

async function deleteProductById(id) {
  return await apiDelete(`${API.products}/${id}`);
}

// Gestion de l'admin
function isAdmin() {
  return sessionStorage.getItem('admin') === '1';
}

function setAdmin(v) {
  sessionStorage.setItem('admin', v ? '1' : '0');
  updateAdminUI();
}

function showAdminButtons() {
  qs('.admin-actions').forEach(btn => btn.style.display = 'flex');
  setTimeout(() => {
    renderProducts();
  }, 0);
}

function hideAdminButtons() {
  qs('.admin-actions').forEach(btn => btn.style.display = 'none');
}

// Variables d'√©tat
let editingId = null;
let editingSectionId = null;

// Gestion des onglets admin
function initAdminTabs() {
  const tabs = qs('.admin-tab');
  const tabContents = qs('.tab-content');
  
  tabs.forEach(tab => {
    tab.onclick = () => {
      // D√©sactiver tous les onglets
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      // Activer l'onglet cliqu√©
      tab.classList.add('active');
      const tabId = tab.dataset.tab + '-tab';
      $(`#${tabId}`).classList.add('active');
    };
  });
}

// Fonction pour afficher les sections
async function renderSections() {
  try {
    const list = $('#sections-list');
    if (!list) return;

    list.innerHTML = '';
    let sections = await loadSections();
    
    // TRIER PAR DATE DE MISE √Ä JOUR (les plus r√©centes en premier)
    sections.sort((a, b) => {
      const dateA = new Date(a.updatedAt || a.createdAt || a._id);
      const dateB = new Date(b.updatedAt || b.createdAt || b._id);
      return dateB - dateA; // D√©croissant
    });

    // Liste admin
    sections.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>${s.name}</span>
        <span>
          <button class="small btn secondary edit-section" data-id="${s._id || s.id}">Edit</button>
          <button class="small btn secondary del-section" data-id="${s._id || s.id}">Suppr</button>
        </span>
      `;
      list.appendChild(li);
    });

    // √âv√©nements pour les boutons
    qs('.edit-section').forEach(b => b.onclick = () => startEditSection(b.dataset.id));
    qs('.del-section').forEach(b => b.onclick = () => handleDeleteSection(b.dataset.id));

    // Mise √† jour des s√©lecteurs
    await updateSectionSelects(sections);
    buildSectionNav(sections);
    await renderSectionFilter();
  } catch (error) {
    console.error('Error in renderSections:', error);
  }
}

async function updateSectionSelects(sections) {
  const sel = $('#section-select');
  if (!sel) return;

  sel.innerHTML = '<option value="">-- Choisir une section --</option>';
  
  // TRIER PAR DATE DE MISE √Ä JOUR
  sections.sort((a, b) => {
    const dateA = new Date(a.updatedAt || a.createdAt || a._id);
    const dateB = new Date(b.updatedAt || b.createdAt || b._id);
    return dateB - dateA; // D√©croissant
  });
  
  sections.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s._id || s.id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

async function renderSectionFilter() {
  const sel = $('#section-filter');
  if (!sel) return;

  sel.innerHTML = '<option value="">Toutes les sections</option>';
  let sections = await loadSections();
  
  // TRIER PAR DATE DE MISE √Ä JOUR
  sections.sort((a, b) => {
    const dateA = new Date(a.updatedAt || a.createdAt || a._id);
    const dateB = new Date(b.updatedAt || b.createdAt || b._id);
    return dateB - dateA; // D√©croissant
  });
  
  sections.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s._id || s.id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

// Gestion des sections
function clearSectionForm() {
  editingSectionId = null;
  $('#section-input').value = '';
}

async function addOrUpdateSection() {
  try {
    const name = $('#section-input').value.trim();
    if (!name) return alert('Nom de section requis');

    if (editingSectionId) {
      await saveSection({ id: editingSectionId, name });
    } else {
      await addSection({ name });
    }

    clearSectionForm();
    await renderSections();
    await renderProducts();
  } catch (error) {
    console.error('Error in addOrUpdateSection:', error);
    alert('Erreur lors de l\'op√©ration sur la section');
  }
}

async function startEditSection(id) {
  try {
    const sections = await loadSections();
    const s = sections.find(x => (x._id || x.id) === id);
    if (!s) return;

    editingSectionId = id;
    $('#section-input').value = s.name;
    
    // Basculer vers l'onglet sections
    qs('.admin-tab').forEach(t => t.classList.remove('active'));
    qs('.tab-content').forEach(c => c.classList.remove('active'));
    $('.admin-tab[data-tab="sections"]').classList.add('active');
    $('#sections-tab').classList.add('active');
  } catch (error) {
    console.error('Error in startEditSection:', error);
  }
}

async function handleDeleteSection(id) {
  if (!confirm('Supprimer cette section et tous ses articles ?')) return;

  try {
    await deleteSectionById(id);

    // Supprimer les produits de cette section
    const products = await loadProducts();
    for (const p of products) {
      if (p.sectionId === id) {
        await deleteProductById(p._id || p.id);
      }
    }

    await renderSections();
    await renderProducts();
  } catch (error) {
    console.error('Error in handleDeleteSection:', error);
    alert('Erreur lors de la suppression de la section');
  }
}

// Gestion des produits
function clearForm() {
  editingId = null;
  $('#name-input').value = '';
  $('#price-input').value = '';
  $('#desc-input').value = '';
  $('#file').value = '';
  $('#preview').innerHTML = '';
  $('#section-select').value = '';
}

async function addOrUpdate() {
  try {
    const n = $('#name-input').value.trim();
    const pr = parseFloat($('#price-input').value) || 0;
    const d = $('#desc-input').value.trim();
    const secId = $('#section-select').value;

    console.log('üîç Section ID r√©cup√©r√©e:', secId, 'Type:', typeof secId);

    if (!n) return alert('Nom requis');
    if (!secId || secId === '' || secId === 'undefined') {
      return alert('Section requise - Veuillez s√©lectionner une section valide');
    }

    const formData = new FormData();
    formData.append('name', n);
    formData.append('price', pr.toString());
    formData.append('description', d);
    formData.append('sectionId', secId);

    const f = $('#file').files[0];
    if (f) {
      formData.append('image', f);
    }

    console.log('üì§ Envoi des donn√©es:', { 
      name: n, 
      price: pr, 
      description: d, 
      sectionId: secId, 
      hasImage: !!f 
    });

    let result;
    if (editingId) {
      const response = await fetch(`${API.products}/${editingId}`, {
        method: 'PUT',
        body: formData
      });
      console.log('üìù R√©ponse modification:', response.status);
      if (!response.ok) throw new Error('Erreur lors de la modification');
      result = await response.json();
    } else {
      const response = await fetch(API.products, {
        method: 'POST',
        body: formData
      });
      console.log('‚ûï R√©ponse ajout:', response.status);
      if (!response.ok) throw new Error('Erreur lors de l\'ajout');
      result = await response.json();
    }

    console.log('‚úÖ Produit cr√©√©/modifi√©:', result);

    clearForm();
    
    // FORCER LE RAFRA√éCHISSEMENT COMPLET POUR VOIR LA NOUVELLE SECTION EN HAUT
    setTimeout(() => {
      location.reload();
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error in addOrUpdate:', error);
    alert('Erreur ajout / modification produit');
  }
}

async function startEdit(id) {
  try {
    const products = await loadProducts();
    const p = products.find(x => (x._id || x.id) === id);
    if (!p) return;

    editingId = id;
    $('#name-input').value = p.name || '';
    $('#price-input').value = p.price || '';
    $('#desc-input').value = p.description || '';
    $('#section-select').value = p.sectionId || '';

    if (p.image) {
      $('#preview').innerHTML = `<img src="${p.image}" style="max-width:100%;max-height:100%">`;
    }

    // Basculer vers l'onglet produits
    qs('.admin-tab').forEach(t => t.classList.remove('active'));
    qs('.tab-content').forEach(c => c.classList.remove('active'));
    $('.admin-tab[data-tab="products"]').classList.add('active');
    $('#products-tab').classList.add('active');

    if (window.innerWidth <= 600) {
      $('#admin-panel').scrollIntoView({ behavior: 'smooth' });
    }
  } catch (error) {
    console.error('Error in startEdit:', error);
  }
}

async function handleDeleteProduct(id) {
  if (!confirm('Supprimer cet article ?')) return;

  try {
    await deleteProductById(id);
    await renderProducts();
  } catch (error) {
    console.error('Error in handleDeleteProduct:', error);
    alert('Erreur lors de la suppression du produit');
  }
}

// Fonction pour g√©n√©rer l'URL WhatsApp
function whatsappUrl(p) {
  const base = 'https://wa.me/' + CONFIG.whatsapp.replace(/\D/g, '');
  const productUrl = `${window.location.origin}${window.location.pathname}#product-${encodeURIComponent(p.name.toLowerCase().replace(/\s+/g, '-'))}`;
  const msg = LANG === 'fr'
    ? `Bonjour Mme Laure, je souhaite commander ${p.name} au prix de ${p.price.toLocaleString()} Fcfa.\nVoir le produit ici : ${productUrl}`
    : `Hello, I want to order ${p.name} for ${p.price.toLocaleString()} Fcfa.\nSee the product here: ${productUrl}`;
  return base + '?text=' + encodeURIComponent(msg);
}

// Navigation par sections - VERSION AVEC MENU COMPACT
function buildSectionNav(sections) {
  const nav = $('#section-nav');
  const sidebarButtons = $('#section-nav-sidebar-buttons');
  
  if (!nav || !sidebarButtons) return;

  nav.innerHTML = '';
  sidebarButtons.innerHTML = '';

  // Bouton "Toutes"
  const allBtn = document.createElement('button');
  allBtn.textContent = 'Toutes';
  allBtn.classList.add('active');
  allBtn.onclick = () => {
    console.log('üéØ Clic sur "Toutes"');
    qs('#section-nav button').forEach(b => b.classList.remove('active'));
    qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
    allBtn.classList.add('active');
    $('#section-filter').value = '';
    renderProducts();
    closeSidebar();
  };
  nav.appendChild(allBtn);

  // Bouton "Toutes" pour le menu lat√©ral
  const allBtnSidebar = document.createElement('button');
  allBtnSidebar.textContent = 'Toutes';
  allBtnSidebar.classList.add('active');
  allBtnSidebar.onclick = () => {
    console.log('üéØ Clic sur "Toutes" (sidebar)');
    qs('#section-nav button').forEach(b => b.classList.remove('active'));
    qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
    allBtnSidebar.classList.add('active');
    $('#section-filter').value = '';
    renderProducts();
    closeSidebar();
  };
  sidebarButtons.appendChild(allBtnSidebar);

  // Trier les sections par date de mise √† jour
  sections.sort((a, b) => {
    const dateA = new Date(a.updatedAt || a.createdAt || a._id);
    const dateB = new Date(b.updatedAt || b.createdAt || b._id);
    return dateB - dateA; // D√©croissant
  });

  // Boutons pour chaque section
  sections.forEach(s => {
    const sectionId = s._id || s.id;
    const sectionName = s.name;
    
    console.log('üìã Cr√©ation bouton pour la section:', sectionName, 'ID:', sectionId);

    // Bouton pour la navigation principale
    const btn = document.createElement('button');
    btn.textContent = sectionName;
    btn.setAttribute('data-section-id', sectionId);
    
    btn.onclick = () => {
      console.log('üéØ Clic sur section:', sectionName, 'ID:', sectionId);
      
      // Mettre √† jour les classes actives
      qs('#section-nav button').forEach(b => b.classList.remove('active'));
      qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Mettre √† jour le filtre et rafra√Æchir
      $('#section-filter').value = sectionId;
      renderProducts().then(() => {
        // Scroll vers la section apr√®s le rendu
        const sectionElement = document.querySelector(`[data-section="${sectionId}"]`);
        if (sectionElement) {
          sectionElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
          });
        }
      });
    };
    
    nav.appendChild(btn);

    // Bouton pour le menu lat√©ral
    const btnSidebar = document.createElement('button');
    btnSidebar.textContent = sectionName;
    btnSidebar.setAttribute('data-section-id', sectionId);
    
    btnSidebar.onclick = () => {
      console.log('üéØ Clic sur section (sidebar):', sectionName, 'ID:', sectionId);
      
      // Mettre √† jour les classes actives
      qs('#section-nav button').forEach(b => b.classList.remove('active'));
      qs('#section-nav-sidebar-buttons button').forEach(b => b.classList.remove('active'));
      btnSidebar.classList.add('active');
      
      // Mettre √† jour le filtre et rafra√Æchir
      $('#section-filter').value = sectionId;
      renderProducts().then(() => {
        // Scroll vers la section apr√®s le rendu
        const sectionElement = document.querySelector(`[data-section="${sectionId}"]`);
        if (sectionElement) {
          sectionElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
          });
        }
      });
      
      closeSidebar();
    };
    
    sidebarButtons.appendChild(btnSidebar);
  });

  console.log('‚úÖ Navigation par sections cr√©√©e avec', sections.length, 'sections');
}

// Gestion du menu lat√©ral
function openSidebar() {
  $('#section-nav-overlay').style.display = 'block';
  $('#section-nav-sidebar').classList.add('show');
}

function closeSidebar() {
  $('#section-nav-overlay').style.display = 'none';
  $('#section-nav-sidebar').classList.remove('show');
}

// Synchroniser la navigation et le select de filtre
function syncSectionFilter() {
  const sectionFilter = $('#section-filter').value;
  const navButtons = qs('#section-nav button');
  const sidebarButtons = qs('#section-nav-sidebar-buttons button');
  
  // Retirer toutes les classes active
  navButtons.forEach(btn => btn.classList.remove('active'));
  sidebarButtons.forEach(btn => btn.classList.remove('active'));
  
  if (!sectionFilter) {
    // Activer "Toutes"
    navButtons[0]?.classList.add('active');
    sidebarButtons[0]?.classList.add('active');
  } else {
    // Activer le bouton correspondant
    const activeBtn = navButtons.find(btn => 
      btn.getAttribute('data-section-id') === sectionFilter
    );
    if (activeBtn) {
      activeBtn.classList.add('active');
    }
    
    const activeSidebarBtn = sidebarButtons.find(btn => 
      btn.getAttribute('data-section-id') === sectionFilter
    );
    if (activeSidebarBtn) {
      activeSidebarBtn.classList.add('active');
    }
  }
}

// Affichage des produits
async function renderProducts() {
  try {
    console.log('üîÑ D√©but de renderProducts');
    const grid = $('#products-grid');
    if (!grid) {
      console.error('‚ùå products-grid non trouv√©');
      return;
    }

    grid.innerHTML = '';

    const products = await loadProducts();
    console.log('üì¶ Produits charg√©s:', products);

    let sections = await loadSections();
    console.log('üìÅ Sections charg√©es:', sections);

    const q = normalizeString($('#search').value.trim());
    const sectionFilter = $('#section-filter').value;
    const sortVal = $('#sort').value;

    console.log('üîç Filtres - Recherche:', q, 'Section:', sectionFilter, 'Tri:', sortVal);

    // Trier les produits - LES PLUS R√âCENTS EN PREMIER
    let sortedProducts = [...products];
    if (sortVal === 'price-asc') {
      sortedProducts.sort((a, b) => a.price - b.price);
    } else if (sortVal === 'price-desc') {
      sortedProducts.sort((a, b) => b.price - a.price);
    } else {
      // Tri par d√©faut : ID d√©croissant (les plus r√©cents en premier)
      sortedProducts.sort((a, b) => {
        const idA = a._id || a.id;
        const idB = b._id || b.id;
        return idB.localeCompare(idA);
      });
    }

    // TRIER PAR DATE DE MISE √Ä JOUR
    sections.sort((a, b) => {
      const dateA = new Date(a.updatedAt || a.createdAt || a._id);
      const dateB = new Date(b.updatedAt || b.createdAt || b._id);
      return dateB - dateA; // D√©croissant
    });

    // IDs des sections correspondant √† la recherche
    const matchedSectionIds = new Set();
    if (q) {
      sections.forEach(s => {
        const sectionId = s._id || s.id;
        if (normalizeString(s.name).includes(q)) matchedSectionIds.add(sectionId);
      });
    }

    let hasDisplayedProducts = false;

    // Afficher par section
    for (const section of sections) {
      const sectionId = section._id || section.id;
      const sectionName = section.name;

      // Appliquer le filtre de section
      if (sectionFilter && sectionId !== sectionFilter) {
        console.log(`‚è© Section "${sectionName}" ignor√©e (filtre: ${sectionFilter})`);
        continue;
      }

      let sectProducts = sortedProducts.filter(p => (p.sectionId || p.sectionId) === sectionId);

      // Appliquer la recherche
      if (q) {
        sectProducts = sectProducts.filter(p => {
          const productText = normalizeString((p.name || '') + ' ' + (p.description || ''));
          return productText.includes(q) || matchedSectionIds.has(sectionId);
        });
      }

      if (sectProducts.length === 0) {
        console.log(`‚è© Section "${sectionName}" sans produits correspondants`);
        continue;
      }

      console.log(`‚úÖ Affichage section "${sectionName}" avec ${sectProducts.length} produits`);

      const secDiv = document.createElement('div');
      secDiv.setAttribute('data-section', sectionId);
      secDiv.innerHTML = `<h3 id="section-${sectionId}">${sectionName}</h3>`;

      const sectGrid = document.createElement('div');
      sectGrid.className = 'grid';

      for (const product of sectProducts) {
        const card = document.createElement('article');
        card.className = 'card';

        const imageSrc = product.image || '';
        const imageHtml = imageSrc
          ? `<img src="${imageSrc}" alt="${product.name}">`
          : '<div class="muted">Aucune image</div>';

        const productId = product._id || product.id;
        
        card.innerHTML = `
          <div class="thumb">${imageHtml}</div>
          <div class="card-body">
            <div class="name">${product.name}</div>
            <div class="desc">${product.description || ''}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="price">${(product.price || 0).toLocaleString()} Fcfa</div>
              <div class="card-actions">
                <a class="small btn" href="${whatsappUrl(product)}" target="_blank">${t('order')}</a>
                ${isAdmin() ? `
                  <div class="admin-actions">
                    <button class="small btn secondary edit" data-id="${productId}">Edit</button>
                    <button class="small btn secondary del" data-id="${productId}">Suppr</button>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        sectGrid.appendChild(card);
        hasDisplayedProducts = true;
      }

      secDiv.appendChild(sectGrid);
      grid.appendChild(secDiv);
    }

    // Afficher les produits sans section UNIQUEMENT si pas de filtre actif
    if (!sectionFilter) {
      const productsWithoutSection = sortedProducts.filter(p => 
        !p.sectionId || p.sectionId === 'undefined' || p.sectionId === 'null'
      );

      if (productsWithoutSection.length > 0) {
        console.log('üì¶ Affichage produits sans section:', productsWithoutSection.length);
        
        const secDiv = document.createElement('div');
        secDiv.setAttribute('data-section', 'undefined');
        secDiv.innerHTML = `<h3 id="section-undefined">‚ö†Ô∏è Produits non class√©s</h3>`;
        const sectGrid = document.createElement('div');
        sectGrid.className = 'grid';

        for (const product of productsWithoutSection) {
          const card = document.createElement('article');
          card.className = 'card';

          const imageSrc = product.image || '';
          const imageHtml = imageSrc
            ? `<img src="${imageSrc}" alt="${product.name}">`
            : '<div class="muted">Aucune image</div>';

          const productId = product._id || product.id;

          card.innerHTML = `
            <div class="thumb">${imageHtml}</div>
            <div class="card-body">
              <div class="name">${product.name}</div>
              <div class="desc">${product.description || ''}</div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="price">${(product.price || 0).toLocaleString()} Fcfa</div>
                <div class="card-actions">
                  <a class="small btn" href="${whatsappUrl(product)}" target="_blank">${t('order')}</a>
                  ${isAdmin() ? `
                    <div class="admin-actions">
                      <button class="small btn secondary edit" data-id="${productId}">Edit</button>
                      <button class="small btn secondary del" data-id="${productId}">Suppr</button>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          `;

          sectGrid.appendChild(card);
          hasDisplayedProducts = true;
        }

        secDiv.appendChild(sectGrid);
        grid.appendChild(secDiv);
      }
    }

    // Message si aucun produit trouv√©
    if (!hasDisplayedProducts) {
      grid.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--muted);">
          <h3>Aucun produit trouv√©</h3>
          <p>Essayez de modifier vos crit√®res de recherche ou de filtre</p>
        </div>
      `;
    }

    // √âv√©nements pour les images
    qs('.thumb').forEach(thumb => {
      thumb.onclick = () => {
        const img = thumb.querySelector('img');
        if (img && img.src) {
          $('#img-modal img').src = img.src;
          $('#img-modal').style.display = 'flex';
        }
      };
    });

    // √âv√©nements pour les boutons admin
    qs('.edit').forEach(btn => {
      btn.onclick = () => startEdit(btn.dataset.id);
    });

    qs('.del').forEach(btn => {
      btn.onclick = () => handleDeleteProduct(btn.dataset.id);
    });

    console.log('‚úÖ renderProducts termin√© - Produits affich√©s:', hasDisplayedProducts);

  } catch (error) {
    console.error('‚ùå Error in renderProducts:', error);
  }
}

// Mise √† jour de l'interface admin
function updateAdminUI() {
  const panel = $('#admin-panel');
  const adminBtn = $('#admin-btn');

  if (!panel || !adminBtn) return;

  if (isAdmin()) {
    panel.classList.add('show');
    adminBtn.style.display = 'none';
    showAdminButtons();
  } else {
    panel.classList.remove('show');
    adminBtn.style.display = 'inline-block';
    hideAdminButtons();
  }
}

// Initialisation
document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Ann√©e du footer
    const yearEl = $('#year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    // Initialisation de l'interface
    await renderSections();
    await renderProducts();
    updateAdminUI();

    // Initialiser les onglets admin
    initAdminTabs();

    // √âv√©nements pour la navigation compacte
    $('#section-nav-toggle').onclick = openSidebar;
    $('#close-sidebar').onclick = closeSidebar;
    $('#section-nav-overlay').onclick = closeSidebar;

    // √âv√©nements
    $('.logo').onclick = () => {
      const pw = prompt("R√©serv√© √† l'administrateur");
      if (pw === CONFIG.defaultPassword) {
        setAdmin(true);
      } else {
        alert('Mot de passe incorrect');
      }
    };

    $('#logout').onclick = () => { 
      setAdmin(false); 
    };

    $('#add-btn').onclick = addOrUpdate;
    $('#cancel-edit').onclick = clearForm;
    $('#add-section-btn').onclick = addOrUpdateSection;
    $('#clear-section-btn').onclick = clearSectionForm;

    $('#search').oninput = renderProducts;
    $('#sort').onchange = renderProducts;
    $('#section-filter').onchange = () => {
      syncSectionFilter();
      renderProducts();
    };

    // Toggle du panel admin
    let minimized = false;
    $('#admin-toggle').onclick = () => {
      const content = $('#admin-content');
      minimized = !minimized;
      content.style.display = minimized ? 'none' : 'block';
      $('#admin-toggle').textContent = minimized ? '+' : '‚Äì';
    };

    // Preview d'image
    $('#file').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;

      const reader = new FileReader();
      reader.onload = () => {
        $('#preview').innerHTML = `<img src="${reader.result}">`;
      };
      reader.readAsDataURL(f);
    };

    // Changement de langue
    $('#lang-fr').onclick = () => { LANG = 'fr'; renderProducts(); };
    $('#lang-en').onclick = () => { LANG = 'en'; renderProducts(); };

    // Modal d'image
    $('#close-modal').onclick = () => {
      $('#img-modal').style.display = 'none';
    };

    // V√©rifier si d√©j√† admin
    if (isAdmin()) updateAdminUI();
  } catch (error) {
    console.error('Error during initialization:', error);
  }
});
</script>
</body>
</html>
